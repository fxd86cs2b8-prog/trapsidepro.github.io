<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Qwen Air Pro</title>

  <!-- Import map for web-llm -->
  <script type="importmap">
    { "imports": { "@mlc-ai/web-llm": "https://esm.run/@mlc-ai/web-llm" } }
  </script>

  <style>
    /* Slim, essential styles only (safe-area-aware) */
    :root { --primary:#007AFF; --danger:#FF3B30; --bg:#f6f8fb; --card:#ffffff; --muted:#8e8e93; --glass: rgba(255,255,255,0.85); }
    html,body{height:100%;margin:0;font-family: -apple-system, system-ui, sans-serif;background:linear-gradient(160deg,#a2c2e6,#d4e1f5);-webkit-font-smoothing:antialiased}
    .card{box-sizing:border-box;width:95%;max-width:460px;margin:4vh auto;height:92vh;background:var(--glass);border-radius:16px;padding-top:env(safe-area-inset-top);display:flex;flex-direction:column;overflow:hidden}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:transparent}
    .title{font-weight:600;font-size:16px;color:#111}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:6px 10px;border-radius:12px;font-size:13px;cursor:pointer}
    .btn--danger{color:var(--danger);border-color:rgba(255,59,48,0.12)}
    .toggle{display:inline-flex;align-items:center;gap:6px;font-size:13px}
    #chat{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px;background:transparent}
    .msg{max-width:80%;padding:10px 12px;border-radius:14px;word-break:break-word;font-size:15px;box-shadow:0 1px 0 rgba(0,0,0,0.02)}
    .user{align-self:flex-end;background:var(--primary);color:white;border-bottom-right-radius:4px}
    .assistant{align-self:flex-start;background:#fff;color:#111;border-bottom-left-radius:4px}
    .input-row{display:flex;padding:10px;gap:8px;border-top:1px solid rgba(0,0,0,0.04);background:rgba(255,255,255,0.6)}
    input[type="text"]{flex:1;padding:10px 12px;border-radius:18px;border:1px solid #e6e6e6;font-size:15px}
    button#send{background:var(--primary);color:white;border:none;padding:8px 12px;border-radius:12px;cursor:pointer}
    button:disabled{opacity:0.5;cursor:not-allowed}

    /* Overlay used during init + modal for traits edit */
    .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,0.85);z-index:60;padding:20px}
    .progress{width:80%;height:6px;background:#eee;border-radius:6px;overflow:hidden}
    .bar{height:100%;width:0%;background:var(--primary);transition:width 120ms linear}

    .modal{width:92%;max-width:420px;background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,0.12)}
    .modal h3{margin:0 0 8px 0;font-size:15px}
    .traits{display:flex;flex-direction:column;gap:8px;max-height:48vh;overflow:auto;padding-right:6px}
    .trait-row{display:flex;gap:8px;align-items:center}
    .trait-row input{flex:1;padding:8px;border-radius:8px;border:1px solid #eee;font-size:14px}
    .small{font-size:12px;color:var(--muted)}

    /* Minimal responsive adjustments */
    @media (max-width:360px){ .card{padding:8px} .title{font-size:15px} }
  </style>
</head>
<body>
  <div class="card" id="card">
    <div class="overlay" id="overlay" role="status" aria-hidden="true">
      <div class="modal" id="overlayModal" style="text-align:center">
        <div style="margin-bottom:8px;font-weight:600">Setting Up</div>
        <div class="small" id="overlayText">Preparing model…</div>
        <div style="height:12px"></div>
        <div class="progress"><div class="bar" id="overlayBar"></div></div>
      </div>
    </div>

    <header>
      <div class="title">Qwen 2.5 Air (Method 4)</div>
      <div class="controls">
        <label class="toggle" title="Low Power Mode">
          <input type="checkbox" id="lowPowerToggle" />
          <span class="small">Low Power</span>
        </label>
        <button class="btn" id="editTraitsBtn" title="Edit up to 7 user traits">Traits</button>
        <button class="btn btn--danger" id="resetBtn">Reset</button>
      </div>
    </header>

    <main id="chat" aria-live="polite">
      <div class="msg assistant">Ready. Stateless worker strategy active.</div>
    </main>

    <div class="input-row">
      <input id="userInput" type="text" placeholder="Ask me anything..." autocomplete="off" />
      <button id="send">Send</button>
    </div>
  </div>

  <!-- Traits modal (hidden by default) -->
  <div class="overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="traitsTitle">
      <h3 id="traitsTitle">User Traits (max 7)</h3>
      <div class="traits" id="traitsList"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn" id="addTraitBtn">+ Add</button>
        <button class="btn" id="saveTraitsBtn">Save</button>
        <button class="btn" id="cancelTraitsBtn">Cancel</button>
      </div>
      <div class="small" style="margin-top:8px">When Low Power is ON, only the first 3 traits are injected and history is minimized.</div>
    </div>
  </div>

  <script type="module">
    import * as webllm from "@mlc-ai/web-llm";

    // Configuration
    const MODEL_ID = "Qwen2.5-0.5B-Instruct-q4f16_1-MLC";
    const MAX_TRAITS = 7;
    const LOWPOWER_TRAITS_LIMIT = 3; // when low power mode: only inject first 3 traits
    const DEFAULT_HISTORY_TURNS = 1;  // normal mode: keep 1 turn (user+assistant)
    const STORAGE_TRAITS = 'qwen_user_traits_v1';
    const STORAGE_LOWPOWER = 'qwen_lowpower_v1';

    // UI refs
    const chat = document.getElementById('chat');
    const input = document.getElementById('userInput');
    const sendBtn = document.getElementById('send');
    const resetBtn = document.getElementById('resetBtn');
    const overlay = document.getElementById('overlay');
    const overlayText = document.getElementById('overlayText');
    const overlayBar = document.getElementById('overlayBar');
    const lowPowerToggle = document.getElementById('lowPowerToggle');
    const editTraitsBtn = document.getElementById('editTraitsBtn');

    // Modal refs
    const modalOverlay = document.getElementById('modalOverlay');
    const traitsList = document.getElementById('traitsList');
    const addTraitBtn = document.getElementById('addTraitBtn');
    const saveTraitsBtn = document.getElementById('saveTraitsBtn');
    const cancelTraitsBtn = document.getElementById('cancelTraitsBtn');

    // State
    let history = []; // external JS history: [{role:'user'|'assistant', content:'...'}]
    let engine = null;
    let userTraits = [];
    let lowPower = false;

    // Persistence helpers
    function loadTraits() {
      try {
        const raw = localStorage.getItem(STORAGE_TRAITS);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr.slice(0, MAX_TRAITS);
      } catch { return []; }
    }
    function saveTraits(arr) {
      try {
        const toSave = Array.isArray(arr) ? arr.slice(0, MAX_TRAITS) : [];
        localStorage.setItem(STORAGE_TRAITS, JSON.stringify(toSave));
      } catch {}
    }
    function loadLowPower() {
      try { return localStorage.getItem(STORAGE_LOWPOWER) === '1'; } catch { return false; }
    }
    function saveLowPower(v) {
      try { localStorage.setItem(STORAGE_LOWPOWER, v ? '1' : '0'); } catch {}
    }

    // Traits -> system prompt (kept very small)
    function buildSystemPrompt() {
      if (lowPower) {
        // Minimal prompt for lowest VRAM usage
        // include only a tiny directive + up to LOWPOWER_TRAITS_LIMIT traits (short)
        const t = userTraits.slice(0, LOWPOWER_TRAITS_LIMIT).map((s,i)=>`${i+1}. ${s}`).join(" | ");
        return t ? `You are a concise assistant. User: ${t}. Keep replies extremely short.` : `You are a concise assistant. Keep replies extremely short.`;
      } else {
        // Normal (still compact) system prompt with up to MAX_TRAITS traits
        const t = userTraits.slice(0, MAX_TRAITS).map((s,i)=>`${i+1}. ${s}`).join("\n");
        return t ? `You are a concise assistant optimized for mobile. User traits:\n${t}\nKeep answers short.` : `You are a concise assistant optimized for mobile. Keep answers short.`;
      }
    }

    // UI helpers
    function appendMessage(role, text) {
      const el = document.createElement('div');
      el.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
      el.textContent = text;
      chat.appendChild(el);
      chat.scrollTop = chat.scrollHeight;
      return el;
    }

    function setOverlay(show, text = '', progress = undefined) {
      overlay.style.display = show ? 'flex' : 'none';
      overlay.setAttribute('aria-hidden', show ? 'false' : 'true');
      if (text) overlayText.textContent = text;
      if (typeof progress === 'number') overlayBar.style.width = `${Math.max(0, Math.min(1, progress))*100}%`;
    }

    // Engine helper with progress callback (keeps overlay updates minimal)
    async function createEngineWithProgress() {
      return await webllm.CreateMLCEngine(MODEL_ID, {
        initProgressCallback: (report) => {
          const p = Math.max(0, Math.min(1, (report && report.progress) || 0));
          setOverlay(true, (report && report.text) || 'Downloading model...', p);
        }
      });
    }

    // Messages builder using dynamic history size based on low power toggle
    function buildMessages(userText) {
      const system = buildSystemPrompt();
      const historyTurns = lowPower ? 0 : DEFAULT_HISTORY_TURNS;
      const turnsToKeep = historyTurns * 2; // user+assistant entries
      const recent = history.slice(-turnsToKeep).map(m => ({ role: m.role === 'assistant' ? 'assistant' : 'user', content: m.content }));
      const msgs = [{ role: 'system', content: system }, ...recent, { role: 'user', content: userText }];
      return msgs;
    }

    // Main chat (Method 4 lifecycle; immediate unload after final tokens)
    async function runChat() {
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      appendMessage('user', text);

      // Append placeholder assistant message to update during stream
      const aiNode = appendMessage('assistant', '…');

      // Pre-engine UI repaint and block UI: show overlay before heavy work
      setOverlay(true, 'Preparing engine…', 0);
      await new Promise(requestAnimationFrame);

      sendBtn.disabled = true;

      try {
        engine = await createEngineWithProgress();
        setOverlay(true, 'Starting inference…', 1);

        const messages = buildMessages(text);

        let reply = '';
        const stream = await engine.chat.completions.create({ messages, stream: true });

        for await (const chunk of stream) {
          const delta = chunk?.choices?.[0]?.delta?.content || '';
          reply += delta;
          aiNode.textContent = reply || '…';
          chat.scrollTop = chat.scrollHeight;
        }

        // Immediate purge
        await engine.unload();
        engine = null;

        // Save externally
        history.push({ role: 'user', content: text }, { role: 'assistant', content: reply });
        const maxEntries = (lowPower ? 0 : DEFAULT_HISTORY_TURNS) * 2;
        if (maxEntries > 0 && history.length > maxEntries) history = history.slice(-maxEntries);
        if (maxEntries === 0) history = []; // keep empty in strict low-power

        setOverlay(false);
      } catch (err) {
        console.error(err);
        appendMessage('assistant', 'I hit a memory spike and reset. Try again.');
        try { if (engine) await engine.unload(); } catch {}
        engine = null;
        setOverlay(false);
      } finally {
        sendBtn.disabled = false;
      }
    }

    // Reset: clear history and unload engine
    resetBtn.addEventListener('click', async () => {
      history = [];
      chat.innerHTML = '<div class="msg assistant">Memory purged. Ready.</div>';
      try { if (engine) { await engine.unload(); } } catch {}
      engine = null;
      input.value = '';
    });

    // Low-power toggle wiring
    lowPower = loadLowPower();
    lowPowerToggle.checked = lowPower;
    lowPowerToggle.addEventListener('change', () => {
      lowPower = !!lowPowerToggle.checked;
      saveLowPower(lowPower);
      // immediate feedback: show small toast via overlay for a short time
      setOverlay(true, lowPower ? 'Low Power: ON — minimizing context' : 'Low Power: OFF — normal mode', 0.3);
      setTimeout(()=> setOverlay(false), 800);
    });

    // Traits editor UI
    function openTraitsModal() {
      renderTraitsEditor();
      modalOverlay.style.display = 'flex';
      modalOverlay.setAttribute('aria-hidden', 'false');
    }
    function closeTraitsModal() {
      modalOverlay.style.display = 'none';
      modalOverlay.setAttribute('aria-hidden', 'true');
    }
    function renderTraitsEditor() {
      traitsList.innerHTML = '';
      for (let i = 0; i < Math.max(userTraits.length, 1); i++) {
        const row = document.createElement('div');
        row.className = 'trait-row';
        const inputEl = document.createElement('input');
        inputEl.type = 'text';
        inputEl.value = userTraits[i] || '';
        inputEl.placeholder = `Trait ${i+1}`;
        inputEl.addEventListener('input', () => userTraits[i] = inputEl.value);
        const del = document.createElement('button');
        del.className = 'btn';
        del.textContent = 'Remove';
        del.addEventListener('click', () => {
          userTraits.splice(i, 1);
          renderTraitsEditor();
        });
        row.appendChild(inputEl);
        row.appendChild(del);
        traitsList.appendChild(row);
      }
    }
    addTraitBtn.addEventListener('click', () => {
      if (userTraits.length >= MAX_TRAITS) return;
      userTraits.push('');
      renderTraitsEditor();
    });
    saveTraitsBtn.addEventListener('click', () => {
      // sanitize: trim and drop empties, keep max
      userTraits = userTraits.map(s => (s || '').trim()).filter(Boolean).slice(0, MAX_TRAITS);
      saveTraits(userTraits);
      closeTraitsModal();
      setOverlay(true, 'Traits saved', 0.2);
      setTimeout(()=>setOverlay(false), 700);
    });
    cancelTraitsBtn.addEventListener('click', () => closeTraitsModal());
    editTraitsBtn.addEventListener('click', openTraitsModal);

    // Load initial traits (seed with small defaults if none)
    userTraits = loadTraits();
    if (userTraits.length === 0) {
      userTraits = ['Concise', 'Numbered steps', 'English'];
      saveTraits(userTraits);
    }

    // Wire send and Enter key
    sendBtn.addEventListener('click', runChat);
    input.addEventListener('keypress', (e) => { if (e.key === 'Enter') runChat(); });

    // Accessibility: focus input
    input.focus();
  </script>
</body>
</html>
